# Notes from the Source (v0.24)

This summary consolidates key information gleaned from the `ohkami` crate source tree along with the existing docs and [README](../ohkami-0.24/README.md).

## Core Concepts

- **No macros required** for basic route definitions. `Ohkami::new` takes a tuple of `"/path".GET(handler)` style declarations.
- **Typed responses** are generated by macros in [`typed::status`](../ohkami-0.24/ohkami/src/typed/status.rs) so handlers can return structs like `status::Created<JSON<User>>`.
- **Fangs** are middleware. Built‑ins such as `Context`, `BasicAuth`, `CORS` and `Timeout` are defined under [`fang::builtin`](../ohkami-0.24/ohkami/src/fang/builtin).
- **Multiple runtimes** are supported: `tokio`, `smol`, `nio`, `glommio` plus Workers and Lambda adapters.
- **Optional features**: TLS (`howls` with `rustls`), WebSocket (`ws` feature), Server‑Sent Events (`sse` feature) and OpenAPI integration (`openapi` feature).

## Runtime Configuration

`src/config.rs` exposes environment variables for tuning native runtimes:

- `OHKAMI_REQUEST_BUFSIZE` – request buffer size (default 2048 bytes).
- `OHKAMI_KEEPALIVE_TIMEOUT` – keep‑alive timeout in seconds (default 30).
- `OHKAMI_WEBSOCKET_TIMEOUT` – WebSocket session timeout in seconds (default 3600).

These are read lazily via `LazyLock` so the values are parsed once on first use.

## Session Lifecycle

[`session`](../ohkami-0.24/ohkami/src/session/mod.rs) owns each connection. It loops over:
1. Parsing a [`Request`](../ohkami-0.24/ohkami/src/request).
2. Routing through the tree built in [`router`](../ohkami-0.24/ohkami/src/router).
3. Sending the resulting [`Response`](../ohkami-0.24/ohkami/src/response).

If the handler upgrades the connection to WebSocket, the session delegates to [`ws`](../ohkami-0.24/ohkami/src/ws) and obeys the `OHKAMI_WEBSOCKET_TIMEOUT` setting.

## Typed Status Macro

The macro in `typed/status.rs` generates structs for many HTTP statuses. Each struct implements `IntoResponse` and can optionally carry a body. For example:

```rust
pub fn Created<B: IntoBody>(body: B) -> Created<B> { ... }
```

Internally this sets `Content-Type` and `Content-Length` headers automatically.

## WebSocket Handshake Validation

`ws::WebSocketContext` checks for:
- `Connection: Upgrade`
- `Upgrade: websocket`
- `Sec-WebSocket-Version: 13`

It returns a typed error response if any header is missing. Once validated, `ctx.upgrade()` performs the handshake and spawns the WebSocket session.

## Utility Helpers

[`util.rs`](../ohkami-0.24/ohkami/src/util.rs) exposes logging macros (`INFO!`, `WARNING!`, `ERROR!`, `DEBUG!`) that work across native and Worker runtimes. Helper functions cover base64 encoding, cookie iteration, percent encoding and timeouts.

## Additional References

The [STARTUP_GUIDE](STARTUP_GUIDE_v0.24.md) shows how to bootstrap a TLS server. Further examples live under [docs/examples](examples/README.md).

For a catalog of sample applications see [SAMPLES_v0.24.md](SAMPLES_v0.24.md).

